---
title: "Graph standards"
output: rmarkdown::html_vignette
description: What good graphs should look like
vignette: >
  %\VignetteIndexEntry{Graph standards}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

<!-- 

### To do list 

- Most of this is obsolete because much of it is now automated.

-->

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(ggplot2)
library(ggrepel)
library(data.table)
devtools::load_all()

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.align = 'center', 
  out.width = '60%'
)

# No annoying messages
options(no_advisory = TRUE)

# Prep data: US personal expenditure aggregates in US$b
data <- USPersonalExpenditure
data <- as.data.table(data, keep.rownames = TRUE)
data <- melt(data, id.vars = "rn", variable.name = "year", value.name = "value")
setnames(data, "rn", "category")
data[, category := factor(category)]
data[, year := as.numeric(as.character(year))]

# 3 main categories
data_3 <- data[category %in% c("Food and Tobacco", "Household Operation", "Medical and Health")]

# Dual axis graph data
data_dual <- data[category %in% c("Food and Tobacco", "Personal Care")]
data_dual <- dcast(data_dual, year ~ category, value.var = "value")

# Column graph data
data_col <- data[year %in% c(1940, 1960) & category %in% c("Food and Tobacco", "Household Operation", "Medical and Health")]
data_col[, category := factor(category, 
                              c("Food and Tobacco", "Household Operation", "Medical and Health"),
                              c("Food", "Household", "Health"))]

# Change data
data_chg <- copy(data)[, change := value - shift(value), by = category]
```

The purpose of this vignette is to demonstrate how to use the functions in `theme61` to produce a correctly formatted graph in the e61 Institute style.

## Summary

Start by creating a graph using the 'normal' stuff: `ggplot(data, aes(x, y)) + geom_blah()`

Then:
-   [Apply the theme](#theme): (optional) Use `theme_e61()` if you want to add a legend, or change its position. Other aspects of `theme_e61()` are now added by default (you can overide this functionality by explicitly using `ggplot2::ggplot()` instead of just `ggplot()` which is now a theme61 function. 
-   [Format the x and y axes scales](#scales): (optional) Format the x and y axes scales: `scale_y_continuous_e61()`, `scale_x_continuous_e61()`. Your y-axis will be automatically scaled when you save your chart using `save_e61()` but if you do not like the automatic scaling then you can always scale you axes manually.
-   [Add labels to your lines/points/bars](#labels): `mplot_label()` or `plot_label()`
-   [Add titles, axes labels, footnotes and sources](#titles): `labs_e61(title = "Title", footnotes = "Footnotes", sources = c("Source 1", "Source 2"))`
-   [Save the graph](#save): `save_e61()` (if you want to create an mpanel, you now do it via the `save_e61()` function)

## The starting graph {#start}

We're going to simple ggplot2 graph into one that is correctly formatted in the e61 Institute style using the package features.

In the first step we'll call the base ggplot function explicitly using `ggplot2::ggplot()`. 

```{r}
gg <- ggplot2::ggplot(data_3, aes(x = year, y = value, colour = category)) + 
  geom_line() + 
  theme(legend.position = "bottom")
```

```{r, echo = FALSE}
ggsave(here::here("man/figures/g-prev.svg"), gg, height = 7.9, width = 8.5, units = "cm")
knitr::include_graphics(here::here("man/figures/g-prev.svg"))
```

## Applying the e61 theme to the graph {#theme}

Most of the theming is done by the `theme_e61()` function. This is now included automatically in `theme61::ggplot()` (or just by calling `ggplot()` when you have the package loaded).

`theme_e61()` deliberately steers you away from long y-axis titles. The information required to interpret the graph should be contained in the title or subtitle.

```{r}
gg <- ggplot(data, aes(x = year, y = value, colour = category)) + 
  geom_line()
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-start.svg"))
knitr::include_graphics(here::here("man/figures/g-start.svg"))
```

### The theme61 colour palette

`theme61` comes with a comprehensive colour palette that you can use in your colour and fill scales. These are now automatically added when you use `theme61::ggplot()` and add either a fill or colour aesthetic variable. The colour palette also comes with colour and fill functions (`scale_colour_e61()` and `scale_fill_e61()`) that you can use if you want to add them to other plots or you do not define your colour and fill variables in the main `ggplot` call (e.g. if you were to define them within an `aes` call in `geom_line()`).

In case you want to customise the chosen colours, all of the valid colours in the e61 colour palette are stored as named objects in the package, they can be accessed by name (see [here](https://e61-institute.github.io/theme61/reference/index.html#colours) for the full list of names). The colour name can be deduced from the position in the colour palette image below.

-   Naming syntax: `e61_<colour name nospaces><numeric position on the scale>`
-   Examples: `e61_bluedark3` or `e61_maroonlight8`.
-   Specifying just the colour name (e.g. `e61_teallight`) will also select the left-most colour on the scale (colour "0").

```{r theme61-colours, echo = FALSE, out.width='80%'}
source("colour-palette.R")
knitr::include_graphics(here::here("man/figures/g-palette-colours.svg"))
```

## Formatting graph colours {#colours}

`scale_colour_e61()` and `scale_fill_e61()` are automatically added when you use `theme61::ggplot()` and add either a fill or colour aesthetic variable.

`palette_e61()` gives you manual access to the colour hex codes.

```{r}
gg <- 
  ggplot(data, aes(x = year, y = value, colour = category)) + 
  geom_line()
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-colours.svg"))
knitr::include_graphics(here::here("man/figures/g-colours.svg"))
```

## Formatting axis scales {#scales}

Your y-axis labels are now automatically scaled to aesthetic values when you save your chart using `save_e61()`.

However, if you do not like the defaults applied in `save_e61()` you can still manually specify the axis limits in the `limits` argument of `scale_y_continuous_e61()`.

### Axes labelling

At e61 we follow the 'Kaplan Rule' when making charts, which means that the title and subtitle of your graph should reflect what your chart is actually showing, not what you interpret it to be showing.

There should also be enough information in the title and subtitle that your y-axis label should be primarily used to reflect the units of the y-axis (e.g. \$, %, \$000s, 000s, ptile, ppt). Consequentially, the y-axis labels in `theme61` are designed to have space for short labels of 1-5 characters.

The package also defaults to showing no x-axis title. This is because in our line of work the x-axis is usually very obvious. For example, if the x-axis is "2010, 2011, 2012, ...", then it is obviously a time series in years, which would be a waste of space to label. Save the x-axis labels for when the x-axis actually requires explanation.

Some examples of y-axis labels:

-   **Good:** %, ppt, \$, '000, \$m, \$b, index, ratio.
-   **Bad (these are all too long and should be included in the subtitle):** US Personal Expenditures (\$ billions), Number of individuals, Model coefficient estimates (ppt), Other long sentences.

```{r}
gg <- 
  ggplot(data, aes(x = year, y = value, colour = category)) + 
  geom_line() +
  labs_e61(y = "$b")
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-axis.svg"))
knitr::include_graphics(here::here("man/figures/g-axis.svg"))
```

## Plot labelling {#labels}

*A full guide to plot labelling is [here](ongraph-labels.html).*

On plot labels are generally preferred to legends, so `theme61` defaults to hiding the legends. You can add a legend and a legend title (if needed) using `theme_e61(legend = "bottom", legend_title = "blah")`

The reason for using on plot labels is that legends generally require you to rapidly flip between the coloured lines or bars on the graph and match them with a box outside the graph that tells you what that colour represents. This creates additional cognitive load, making the message of your graph harder and slower to communicate to the audience and therefore making your graph is less effective.

Graph labels put the label on the graph directly, near the data point that is being identified. This makes it faster to figure out what the graph is about.

```{r}
gg <- 
  ggplot(data_3, aes(x = year, y = value, colour = category)) + 
  geom_line() +
  labs_e61(y = "$b") +
  mplot_label(
    c("Food and\nTobacco", "Household\nOperation", "Medical and\nHealth"),
    c(1944, 1954, 1953),
    c(65, 55, 25)
  )
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-labels.svg"))
knitr::include_graphics(here::here("man/figures/g-labels.svg"))
```

## Graph titles, subtitles and footers {#titles}

When adding titles, subtitles, captions and sources, use `labs_e61()`. Text is automatically wrapped if it is too long on one line when you use `save_e61()`. You can adjust this (e.g. manually supply the maximum number of characters for a title, subtitle or footnotes using title_max_char etc.) or turn it off (set `auto_scale = FALSE` in `save_e61()`). Sources are automatically reordered in alphabetical order if you supply the sources as a character vector.

```{r}
gg <- ggplot(data_3, aes(x = year, y = value, colour = category)) + 
  geom_line() +
  mplot_label(c("Food and\nTobacco", "Household\nOperation", "Medical and\nHealth"),
              c(1944, 1954, 1953),
              c(65, 55, 25)) +
  labs_e61(
    title = "US personal expenditures*",
    subtitle = "1940-1960",
    y = "$b",
    footnotes = "Data comes from the built-in 'USPersonalExpenditure' dataset.",
    sources = c("e61 Institute", "'datasets' package")
  )
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-titles.svg"))
knitr::include_graphics(here::here("man/figures/g-titles.svg"))
```

## Saving graphs {#save}

Make sure you use `save_e61()` when saving graphs at e61. `save_e61()` ensures that the relative size of your graph elements and text is appropriate. It will also apply sensible limits and scales to your y-axis if you have not already added your own custom limits.

You should generally save your graphs using a vector graphics format (SVG or PDF). SVGs are a modern vector graphics format, which is the highly recommended format because you can resize them to any size without pixelation. If you are making graphs for LaTeX documents, you will need to save the graphs in PDF format for them to render as LaTeX does not support SVGs. If you need to use a raster format (e.g. for posting on the website formerly known as Twitter), the package does support PNGs, although some customisation features may be unavailable.

You do not need to supply the ggplot object when using `save_e61()` as it automatically saves the last-created graph, although supplying the chart to `save_e61()` can minimise the likelihood of errors. If you are saving a multi-panel chart (see mpanel section below) using `save_e61()`, then you will need to supply the charts.

The `save_data` argument also lets you save a `.csv` file with the data used to create a graph.

## Additional features

### Dual y-axis scale support

Note: Admittedly this feature is somewhat advanced/fiddly.

Despite [Hadley's best efforts](https://stackoverflow.com/questions/3099219/ggplot-with-2-y-axes-on-each-side-and-different-scales/3101876#3101876) to make it difficult to add a differently-scaled second y-axis, this feature now exists in `theme61.`

Implementing dual y-axis requires a fair amount of additional faff that I will try and step through.

First, the structure of your data needs to be different to the usual best practice. Normally, you want your data in long format, and add separate groups using `colour` or `fill`. However, if you want one of the lines on the secondary axis, each series needs to be in its own column. 

Each series will also be plotted separately with its own `geom_line()` (or any other `geom_` depending on what you want to plot obviously), as in the example below.

You need to then transform the `y` aesthetic in the series to be plotted on the secondary axis using the `sec_rescale_inv()` function (see the documentation for the required arguments).

You also need to manually specify the colour to colour in the lines, using `palette_e61()`.

You must then specify the `sec_axis` argument in `scale_y_continuous_e61()` with `sec_axis(~sec_rescale(.), name = "name")`. Replace "name" with the y-axis label. This must be specified otherwise it will show up blank.

You also need to set `rescale_sec = TRUE` to ensure the formatting is appropriately adjusted for the secondary axis.

Finally, you will need to run your code twice, as the first time, there will be an error caused by how R internally assigns objects generated by simultaneous function calls (this may get fixed in the future). 

```{r, echo = FALSE}
# Store scale and shift vars to supply to sec_rescale()
# This is needed for the vignette to run
assign("sec_axis_scale", 0.1, envir = t61_env)
assign("sec_axis_shift", 0, envir = t61_env)
```

```{r}
gg <- 
  ggplot(data_dual, aes(x = year)) + 
  geom_line(aes(y = `Food and Tobacco`), colour = palette_e61(2)[[1]]) +
  # All the action is in the next two lines
  geom_line(aes(y = sec_rescale_inv(`Personal Care`, scale = 0.1, shift = 0)), 
            colour = palette_e61(2)[[2]]) +
  scale_y_continuous_e61(limits = c(0, 100, 25), name = "$b",
                         sec_axis = sec_axis(~sec_rescale(.), name = "$b"), 
                         rescale_sec = TRUE) +
  mplot_label(c("Food and Tobacco\n(LHS)", "Personal Care\n(RHS)"),
              c(1945, 1948),
              c(75, 40))
```

```{r, echo=FALSE}
save_e61(here::here("man/figures/g-dual.svg"))
knitr::include_graphics(here::here("man/figures/g-dual.svg"))
```

### Multi-panel graph support {#mpanel}

We have discovered in our research notes that putting multiple graphs together in a grid/panel works quite well with the format. `mpanel_e61()` is a function that makes the task of producing multi-panel graphs easier.

Note that graph titles need to be done differently in multi-panels. Each individual graph probably should not have sources or footnotes, they should be in the footer of the full multi-panel instead.

First we make the sub-plots as their own graph.

```{r}
g1 <-
  ggplot(data_3, aes(x = year, y = value, colour = category)) +
  geom_line() +
  mplot_label(c("Food and\nTobacco", "Household\nOperation", "Medical and\nHealth"),
              c(1944, 1954, 1953),
              c(65, 55, 25)) +
  labs_e61(
    title = "Aggregates",
    y = "$b"
  )

g2 <- ggplot(data_dual, aes(x = year)) +
    geom_line(aes(y = `Food and Tobacco`), colour = palette_e61(2)[[1]]) +
    geom_line(aes(y = `Personal Care`), colour = palette_e61(2)[[2]]) +
    scale_y_continuous_e61(limits = c(0, 100, 25)) +
  mplot_label(
    c("Food and Tobacco\n(LHS)", "Personal Care\n(RHS)"),
    c(1945, 1952),
    c(75, 15)
  ) +
  labs_e61(
    title = "Selected Aggregates",
    y = "$b"
  )

g3 <-
  ggplot(data_col, aes(x = category, y = value, fill = factor(year))) +
  geom_col(position = "dodge") +
  mplot_label(c("1940", "1960"),
              c(1.55, 2.05),
              c(15, 50)) +
  labs_e61(
    title = "1940 to 1960 Change", 
    y = "$b"
  )

g4 <- 
  ggplot(data_chg[category == "Food and Tobacco"], aes(x = year)) +
  geom_line(aes(y = value), colour = palette_e61(2)[[1]]) +
  geom_col(aes(y = change), fill = palette_e61(2)[[2]]) +
  scale_y_continuous_e61(limits = c(0, 100, 20)) +
  mplot_label(
    c("Aggregate", "Change from\n5 years ago"),
    c(1941, 1952),
    c(55, 25)
  ) +
  labs_e61(
    title = "Food and Tobacco Spending", 
    y = "$b"
  )
```

Then we use the `save_e61()` to put the graphs together.

```{r, echo=FALSE}
save_e61(
    g1, g2, g3, g4,
    filename = here::here("man/figures/g-multi.svg"),
    title = "US Personal Expenditures*",
    footnotes = "Data comes from the built-in USPersonalExpenditure dataset. Data comes from the built-in USPersonalExpenditure dataset. Data comes from the built-in USPersonalExpenditure dataset. Data comes from the built-in USPersonalExpenditure dataset. Data comes from the built-in USPersonalExpenditure dataset. Data comes from the built-in USPersonalExpenditure dataset.",
    sources = c("e61 Institute", "'datasets' package")
)
```

```{r, echo=FALSE}
knitr::include_graphics(here::here("man/figures/g-multi.svg"))
```

### Flipped bar graphs

Flipped bar graphs can be useful, especially if the categories have long names. There are some changes to the `theme()` and `coords` that are required for the flipping to look successful, so I've added a function that does most of the tinkering for you. I called it `format_flip()`.

```{r}
gg <-
  ggplot(data_col, aes(x = category, y = value, fill = factor(year))) +
  geom_col(position = "dodge") +
  coord_flip() +
  mplot_label(c("1940", "1960"),
              c(1.8, 2.2),
              c(15, 50)) +
  labs_e61(
    title = "1940 to 1960 Change", 
    y = "$b"
  ) +
  format_flip()

save_e61(here::here("man/figures/g-flip.svg"))

```

```{r, echo=FALSE, out.width='80%'}
knitr::include_graphics(here::here("man/figures/g-flip.svg"))
```

Notice that `save_e61()` set the default dimensions for flipped graphs reasonably well. Your mileage may vary if you have a weird graph though, so always check the output!

## The finished product

```{r, include=FALSE}
gg <- 
  ggplot(data_3, aes(x = year, y = value, colour = category)) + 
  geom_line() +
  mplot_label(c("Food and\nTobacco", "Household\nOperation", "Medical and\nHealth"),
              c(1944, 1954, 1953),
              c(65, 55, 25)) +
  labs_e61(
    title = "US Personal Expenditures*",
    subtitle = "1940-1960",
    footnotes = "Data comes from the built-in USPersonalExpenditure dataset.",
    sources = c("e61 Institute", "'datasets' package"),
    y = "$b"
  )
save_e61(here::here("man/figures/g-post.svg"))
```

```{r, echo=FALSE, out.width="49%", out.height="20%", fig.cap=" ", fig.show='hold', fig.align='center'}
knitr::include_graphics(c(here::here("man/figures/g-prev.svg"), here::here("man/figures/g-post.svg")))
```
